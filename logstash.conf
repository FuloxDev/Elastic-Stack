input {
  tcp {
    port => 5515
    codec => syslog
    tags => ["fortigate"]
    # Optional: Enable SSL/TLS later
    # ssl_enable => true
    # ssl_cert => "/usr/share/logstash/certs/logstash01/logstash01.crt"
    # ssl_key => "/usr/share/logstash/certs/logstash01/logstash01.key"
  }
}

filter {
  if "fortigate" in [tags] {
    # Extract key=value pairs from the syslog message
    kv {
      source => "message"
      field_split => " "
      value_split => "="
      trim_key => "\""
      trim_value => "\""
      allow_duplicate_values => false
      tag_on_failure => ["_kv_failure"]
    }

    # Parse FortiGate timestamp if available
    if [date] and [time] {
      mutate {
        add_field => { "fortigate_timestamp" => "%{date} %{time}" }
      }
      date {
        match => [ "fortigate_timestamp", "yyyy-MM-dd HH:mm:ss" ]
        target => "@timestamp"
      }
      mutate {
        remove_field => ["fortigate_timestamp"]
      }
    }

    # Convert string fields to integers
    mutate {
      convert => {
        "srcport" => "integer"
        "dstport" => "integer"
        "sentbyte" => "integer"
        "rcvdbyte" => "integer"
        "duration" => "integer"
        "policyid" => "integer"
        "sessionid" => "integer"
        "proto" => "integer"
      }
    }

    # Calculate total bytes
    if [sentbyte] and [rcvdbyte] {
      ruby {
        code => "
          sent = event.get('sentbyte') || 0
          rcvd = event.get('rcvdbyte') || 0
          event.set('totalbytes', sent + rcvd)
        "
      }
    }

    # Clean up temporary/parsing fields
    mutate {
      remove_field => ["message", "syslog_pri", "port"]
      # Keep [host] (FortiGate IP), remove only if needed
    }
  }
}

output {
  if "fortigate" in [tags] {
    elasticsearch {
      hosts => "${ELASTIC_HOSTS}"
      user => "${ELASTIC_USER}"
      password => "${ELASTIC_PASSWORD}"
      ssl_certificate_authorities => "certs/ca/ca.crt"
      ssl_enabled => true
      index => "fortigate-logs-%{+yyyy.MM.dd}"
    }
  } else {
    elasticsearch {
      hosts => "${ELASTIC_HOSTS}"
      user => "${ELASTIC_USER}"
      password => "${ELASTIC_PASSWORD}"
      ssl_certificate_authorities => "certs/ca/ca.crt"
      ssl_enabled => true
      index => "logstash-%{+YYYY.MM.dd}"
    }
  }
}